# ================================
# YAF Config Agent Dockerfile
# ================================
FROM golang:1.21-alpine AS builder

WORKDIR /build

# 安装依赖
RUN apk add --no-cache git ca-certificates

# 复制 go.mod 和 go.sum
COPY config-agent/go.mod config-agent/go.sum* ./

# 下载依赖
RUN go mod download

# 复制源代码
COPY config-agent/ ./

# 编译
RUN CGO_ENABLED=0 GOOS=linux go build -ldflags="-w -s" -o yaf-config-agent ./cmd/agent

# ================================
# 运行阶段 - 最小化镜像
# ================================
FROM alpine:3.19

RUN apk add --no-cache ca-certificates tzdata

ENV TZ=Asia/Shanghai
RUN ln -snf /usr/share/zoneinfo/$TZ /etc/localtime && echo $TZ > /etc/timezone

WORKDIR /app

COPY --from=builder /build/yaf-config-agent /usr/local/bin/yaf-config-agent

# 默认环境变量
ENV ZK_SERVERS=localhost:2181
ENV YAF_CLUSTER=default
ENV YAF_NODE_ID=node-1
ENV YAF_CONFIG_PATH=/etc/yaf/yaf.init
ENV YAF_INTERFACE=eth0

CMD ["yaf-config-agent"]

